

shinyServer(function(input, output, session) { 

# Datos ----
# ·······························································································
 
    
   startTime <- as.numeric(Sys.time())
   
   weatherData <- reactive({
       
       invalidateLater(5000, session)
       
       N <- min((as.numeric(Sys.time()) - startTime)/5 + 30, 1000)
       
       read.csv("Data/weatherdata.csv") %>%
           slice(1:N) %>%
           mutate(Dates = as.POSIXct(Dates)) %>%
           slice((n()-30):n())
       
   })
   
  
   
# Graficas ----
# ·······························································································
       output$temp <- renderPlot({
       
       weatherData<- weatherData()
       
       qplot(Dates, Temperature, data = weatherData, geom = "line") 
       
   })
   
   
   output$rain <- renderPlot({
       
       weatherData<- weatherData()
       
       ggplot(data = weatherData(), aes(Dates, Rainfall)) + 
           geom_bar(stat = "identity")
       
   })
   
   output$maxTemp <- renderValueBox({
       
       weatherData <- weatherData()
       
       maxTemp <- max(weatherData$Temperature, na.rm = TRUE)
       
       valueBox(maxTemp,
                subtitle = "Maximum Temperature (celsius)", 
                icon     = icon("arrow-up"),
                color    = "light-blue")
       
   })
   
   output$minTemp <- renderValueBox({
       
       weatherData <- weatherData()
       
       minTemp <- min(weatherData$Temperature, na.rm = TRUE)
       
       valueBox(minTemp,
                subtitle = "Minimum Temperature (celsius)", 
                icon     = icon("arrow-down"),
                color    = "light-blue")
       
   })
   
   output$averageRainfall <- renderValueBox({
       
       weatherData <- weatherData()
       
       meanRain <- round(mean(weatherData$Rainfall, na.rm = TRUE),1)
       
       valueBox(meanRain, 
                subtitle = "Average Monthly rainfall (mm)", 
                icon     = icon("cloud"),
                color    = "orange")
   })
   
   # Creamos las tablas de datos
   output$tb1 <- DT::renderDataTable(show_tabla(historico.cuentas))
   output$tb2 <- DT::renderDataTable(show_tabla(historico.tweets))
   output$tb3 <- DT::renderDataTable(show_tabla(historico.menciones))
   output$tb4 <- DT::renderDataTable(show_tabla(historico.seguidores))
   
   output$a <- DT::renderDataTable(DT::datatable(
       iris,
       extensions = 'Buttons', options = list(
           dom = 'Bfrtip',
           buttons = 
               list('copy', 'print', list(
                   extend = 'collection',
                   buttons = c('csv', 'excel', 'pdf'),
                   text = 'Download'
               ))
           
       ))
   )
}
)
